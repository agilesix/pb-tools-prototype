name: CI - Test Build & Preview

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository using git
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Test Build
        run: npm run build

      - name: Debug Build Output
        run: |
          echo "=== BUILD DEBUG INFO ==="
          echo "Total files in dist:"
          find dist -type f | wc -l
          echo "Dist directory size:"
          du -sh dist
          echo "Files by extension:"
          find dist -type f | sed 's/.*\.//' | sort | uniq -c | sort -nr | head -10
          echo "USWDS assets check:"
          echo "Font files:"
          find dist -name "*.woff*" | wc -l
          echo "SVG files:"
          find dist -name "*.svg" | wc -l
          echo "Public directory contents:"
          ls -la public/
          echo "Dist directory structure:"
          find dist -type d | head -10

      - name: Deploy Preview
        run: npx wrangler deploy --env preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          ENVIRONMENT: preview
